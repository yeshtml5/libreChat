# Docker 배포 가이드

LibreChat을 Docker로 실서버(3090 서버)에 배포하고 테스트하는 방법에 대한 상세 가이드입니다.

## 🐳 Docker 기본 구조

LibreChat은 다음 Docker 서비스들로 구성됩니다:

```yaml
services:
  api:           # LibreChat 메인 애플리케이션
  mongodb:       # 데이터베이스
  meilisearch:   # 검색 엔진
  vectordb:      # 벡터 데이터베이스
  rag_api:       # RAG (Retrieval Augmented Generation) API
```

## 🚀 프론트엔드 변경 후 실서버 배포 과정

### 1. 로컬에서 변경사항 개발 (Yarn 워크스페이스)

```bash
# 1. 의존성 설치
yarn install

# 2. 패키지 빌드 (순서 중요!)
yarn build:data-schemas
yarn build:data-provider
yarn build:api
yarn build:client-package

# 3. 프론트엔드 개발 (로컬)
yarn frontend:dev

# 4. 변경사항 테스트
yarn test:client

# 5. 빌드 테스트
yarn frontend
```

### 2. Docker 이미지 빌드

**방법 A: 로컬 빌드 (Yarn 포함)**
```bash
# Yarn Berry 포함 Dockerfile 빌드
docker build -t librechat-custom:latest .

# 또는 docker-compose로 빌드
docker-compose build api

# 빌드 전 로컬에서 패키지 빌드 확인
yarn workspaces foreach --parallel run build
```

**방법 B: 공식 이미지 사용 (권장)**
```bash
# docker-compose.yml에서 공식 이미지 사용
image: ghcr.io/danny-avila/librechat-dev:latest
```

### 3. 3090 서버 배포

**서버 접속 및 배포:**
```bash
# 3090 서버 접속 (예시)
ssh user@3090-server-ip

# LibreChat 디렉토리로 이동
cd /path/to/LibreChat

# 기존 컨테이너 중지
docker-compose down

# 최신 이미지 가져오기 (공식 이미지 사용시)
docker-compose pull

# 새로운 컨테이너 시작
docker-compose up -d

# 또는 배포용 compose 파일 사용
docker-compose -f deploy-compose.yml up -d
```

### 4. 배포 확인

```bash
# 컨테이너 상태 확인
docker-compose ps

# 로그 확인
docker-compose logs -f api

# 특정 서비스 로그
docker-compose logs -f mongodb
docker-compose logs -f meilisearch

# 헬스체크
curl http://localhost:3080/health
```

## ⚙️ 환경 설정

### .env 파일 설정 (중요!)

```bash
# .env 파일 예시 (3090 서버용)
PORT=3080
HOST=0.0.0.0

# MongoDB 설정
MONGO_URI=mongodb://mongodb:27017/LibreChat

# 검색 설정
MEILI_HOST=http://meilisearch:7700
MEILI_MASTER_KEY=your_secret_key

# AI API 키들
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key

# 파일 업로드 설정
FILE_UPLOAD_PATH=/app/uploads

# 도커 사용자 설정
UID=1000
GID=1000
```

### docker-compose.override.yml 설정

```yaml
# docker-compose.override.yml
version: '3.8'

services:
  api:
    ports:
      - "3080:3080"  # 포트 매핑 조정
    environment:
      - NODE_ENV=production
      - DEBUG=false
    volumes:
      - ./custom-config:/app/config  # 커스텀 설정 마운트
      
  mongodb:
    ports:
      - "27017:27017"  # 외부 접근 허용 (개발시만)
    
  meilisearch:
    ports:
      - "7700:7700"   # 검색 API 외부 접근
```

## 🔍 실시간 모니터링

### 1. 컨테이너 상태 모니터링

```bash
# 실시간 상태 확인
watch docker-compose ps

# 리소스 사용량 확인
docker stats

# 특정 컨테이너 상세 정보
docker inspect librechat_api_1
```

### 2. 로그 모니터링

```bash
# 실시간 로그 추적
docker-compose logs -f --tail=100 api

# 에러 로그만 필터링
docker-compose logs api | grep -i error

# 로그 파일로 저장
docker-compose logs api > /tmp/librechat.log
```

### 3. 애플리케이션 모니터링

```bash
# API 헬스체크
curl -f http://localhost:3080/health || echo "API Down!"

# 데이터베이스 연결 확인
docker exec -it chat-mongodb mongosh --eval "db.adminCommand('ping')"

# MeiliSearch 상태 확인
curl http://localhost:7700/health
```

## 🔄 업데이트 프로세스

### 1. 무중단 배포 (Blue-Green 방식)

```bash
# 1. 새 버전 이미지 준비
docker-compose pull

# 2. 기존 서비스와 병렬로 새 서비스 시작 (포트 변경)
# docker-compose.override.yml에서 포트를 3081로 변경 후
docker-compose up -d --scale api=2

# 3. 새 버전 테스트
curl http://localhost:3081/health

# 4. 로드밸런서에서 트래픽 전환 (nginx 등)
# 또는 포트를 다시 3080으로 변경

# 5. 기존 버전 종료
docker-compose down --remove-orphans
```

### 2. 간단한 업데이트

```bash
# 스크립트로 자동화 (update.sh)
#!/bin/bash

echo "Stopping LibreChat..."
docker-compose down

echo "Pulling latest image..."
docker-compose pull

echo "Starting LibreChat..."
docker-compose up -d

echo "Checking health..."
sleep 30
curl -f http://localhost:3080/health && echo "✅ Update successful!" || echo "❌ Update failed!"
```

## 🛠️ 트러블슈팅

### 1. 컨테이너 시작 실패

```bash
# 1. 포트 충돌 확인
netstat -tulpn | grep :3080

# 2. 볼륨 권한 확인
ls -la ./uploads ./data-node

# 3. 환경변수 확인
docker-compose config

# 4. 컨테이너 강제 재생성
docker-compose down -v
docker-compose up -d --force-recreate
```

### 2. 빌드 에러 해결

```bash
# 1. Docker 캐시 클리어
docker system prune -a

# 2. 빌드 캐시 없이 재빌드
docker-compose build --no-cache api

# 3. Base 이미지 업데이트
docker pull node:18-alpine
```

### 3. 데이터베이스 연결 문제

```bash
# MongoDB 연결 테스트
docker exec -it chat-mongodb mongosh --eval "db.runCommand({connectionStatus: 1})"

# 네트워크 확인
docker network ls
docker network inspect librechat_default
```

### 4. 성능 이슈

```bash
# 메모리 사용량 확인
docker stats --no-stream

# 컨테이너 제한 설정 (docker-compose.yml)
services:
  api:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
```

## 📊 로그 분석

### 중요 로그 패턴

```bash
# 성공적인 시작
docker-compose logs api | grep "Server listening"

# 데이터베이스 연결
docker-compose logs api | grep "Connected to MongoDB"

# API 에러
docker-compose logs api | grep -E "(ERROR|error|Error)"

# 메모리 관련 이슈
docker-compose logs api | grep -i "memory"
```

## 🔐 보안 설정

### 프로덕션 보안 체크리스트

```bash
# 1. 기본 패스워드 변경
MEILI_MASTER_KEY=strong_random_key

# 2. MongoDB 인증 활성화
# docker-compose.yml에서 --noauth 제거

# 3. 방화벽 설정
ufw allow 3080/tcp
ufw deny 27017/tcp  # MongoDB 외부 접근 차단

# 4. SSL/TLS 설정 (nginx proxy 권장)
```

## 📋 배포 체크리스트

✅ **배포 전 체크:**
- [ ] 로컬 테스트 완료
- [ ] 환경변수 설정 확인
- [ ] 볼륨 마운트 경로 확인
- [ ] 포트 충돌 없음

✅ **배포 후 체크:**
- [ ] 컨테이너 정상 실행 확인
- [ ] 헬스체크 통과
- [ ] 데이터베이스 연결 확인
- [ ] 로그 에러 없음
- [ ] 프론트엔드 정상 로딩

이 가이드를 따라하면 프론트엔드 변경사항을 3090 서버에 안전하게 배포할 수 있습니다.