# 빌드 문제 해결 가이드

LibreChat에서 버전 차이로 인한 빌드 문제와 그 해결 방법에 대한 종합적인 가이드입니다.

## 🚨 주요 빌드 문제들

### 1. 패키지 의존성 문제

**증상:**
```bash
Error: Cannot resolve module '@librechat/data-provider'
Error: Module not found: Can't resolve '@librechat/client'
npm ERR! peer dep missing: react@^18.0.0
```

**원인:** 
- 패키지 빌드가 되지 않아서 발생
- 의존성 버전 불일치
- 모노레포 워크스페이스 설정 문제

**해결방법 (Yarn Berry 워크스페이스):**
```bash
# 1. 모든 워크스페이스 클린 설치
rm -rf node_modules */node_modules packages/*/node_modules
rm -rf .yarn/cache .yarn/install-state.gz
rm -f yarn.lock package-lock.json  # 충돌 방지

# 2. Yarn으로 재설치
yarn install

# 3. 패키지들을 의존성 순서대로 빌드
yarn build:data-schemas      # 1순위: 스키마
yarn build:data-provider     # 2순위: API 클라이언트  
yarn build:api               # 3순위: 백엔드 공통 로직
yarn build:client-package    # 4순위: UI 컴포넌트

# 4. 또는 병렬로 빌드 (의존성 자동 관리)
yarn workspaces foreach --topological run build

# 5. 프론트엔드 빌드
yarn frontend
```

### 2. Node.js 버전 호환성 문제

**증상:**
```bash
Error: The engine "node" is incompatible with this module
digital envelope routines::unsupported
```

**원인:** Node.js 버전이 프로젝트 요구사항과 맞지 않음

**해결방법:**
```bash
# 1. 현재 Node.js 버전 확인
node --version

# 2. 권장 Node.js 버전으로 변경 (18.x LTS)
# nvm 사용시:
nvm install 18
nvm use 18

# 3. Yarn도 최신 버전으로 업데이트
npm install -g yarn
yarn set version 4.9.4

# 4. 재빌드
yarn build:data-provider
```

### 3. TypeScript 컴파일 에러

**증상:**
```bash
TS2307: Cannot find module '@librechat/data-schemas' or its corresponding type declarations
TS2322: Type 'string' is not assignable to type 'never'
```

**해결방법:**
```bash
# 1. TypeScript 캐시 클리어
rm -rf client/node_modules/.cache
rm -rf packages/*/dist
rm -rf packages/*/node_modules/.cache

# 2. 타입 정의 재생성 (워크스페이스 방식)
yarn workspace @librechat/data-schemas build
yarn workspace librechat-data-provider build

# 또는 의존성 순서대로
yarn build:data-schemas
yarn build:data-provider

# 3. TypeScript 설정 검증
yarn workspace client typecheck
# 또는 직접 실행
cd client
yarn tsc --noEmit
```

### 4. Vite 빌드 문제

**증상:**
```bash
[vite]: Rollup failed to resolve import
Cannot access '__VITE_IS_LEGACY__' before initialization
```

**해결방법:**
```bash
# 1. Vite 캐시 클리어
cd client
rm -rf node_modules/.vite
rm -rf dist

# 2. 환경변수 확인
cp .env.example .env
# NODE_ENV=development로 설정

# 3. Vite 설정 디버그
npm run build:file
# 또는 디버그 모드로
DEBUG=vite:* npm run dev
```

### 5. Webpack/Babel 설정 충돌

**증상:**
```bash
Module parse failed: Unexpected token
Support for the experimental syntax 'jsx' isn't currently enabled
```

**해결방법:**
```bash
# 1. Babel 설정 확인
cd client
cat babel.config.cjs

# 2. 필요시 .babelrc 삭제 (babel.config.cjs 우선)
rm -f .babelrc .babelrc.json

# 3. JSX preset 설치 확인
npm list @babel/preset-react
```

## 🔧 버전별 해결책

### React 19 마이그레이션 이슈

**새로운 React 19 기능 사용시:**
```bash
# 1. React 19 호환 패키지로 업데이트
npm install react@^19.0.0 react-dom@^19.0.0
npm install @types/react@^19.0.0 @types/react-dom@^19.0.0

# 2. 호환되지 않는 패키지 확인
npm ls --depth=0 | grep "UNMET PEER DEPENDENCY"

# 3. 필요시 오버라이드 설정 (package.json)
"overrides": {
  "react": "^19.0.0",
  "react-dom": "^19.0.0"
}
```

### ESLint 9.x 마이그레이션

**ESLint 설정 문제:**
```bash
# 기존 .eslintrc.js 를 eslint.config.mjs 로 변환 필요

# 1. 현재 ESLint 설정 검증
npx eslint --print-config client/src/App.jsx

# 2. 새 설정 파일 사용 확인
cat eslint.config.mjs
```

### Yarn vs NPM 혼용 문제

**Lock 파일 충돌:**
```bash
# 1. 하나의 패키지 매니저만 사용 결정
# yarn 사용시:
rm -f package-lock.json
yarn install

# npm 사용시:
rm -f yarn.lock
npm install

# 2. .gitignore에 사용하지 않는 lock 파일 추가
echo "package-lock.json" >> .gitignore  # yarn 사용시
echo "yarn.lock" >> .gitignore          # npm 사용시
```

## 🛠️ 체계적인 문제 해결 프로세스

### 1단계: 환경 정리

```bash
#!/bin/bash
# clean-build.sh

echo "🧹 Cleaning build environment..."

# 모든 node_modules 삭제
find . -name "node_modules" -type d -prune -exec rm -rf {} +

# Lock 파일들 삭제
rm -f package-lock.json yarn.lock
find . -name "package-lock.json" -delete
find . -name "yarn.lock" -delete

# 빌드 결과물 삭제
rm -rf client/dist
rm -rf packages/*/dist
rm -rf api/logs/*

# 캐시 삭제
rm -rf ~/.npm/_cacache
rm -rf ~/.cache/yarn

echo "✅ Environment cleaned!"
```

### 2단계: 순차적 빌드

```bash
#!/bin/bash
# sequential-build.sh

echo "📦 Starting sequential build process..."

# 1. 루트 의존성 설치
echo "Installing root dependencies..."
npm install

# 2. 스키마 빌드 (최우선)
echo "Building data schemas..."
npm run build:data-schemas
if [ $? -ne 0 ]; then
    echo "❌ Data schemas build failed!"
    exit 1
fi

# 3. 데이터 프로바이더 빌드
echo "Building data provider..."
npm run build:data-provider
if [ $? -ne 0 ]; then
    echo "❌ Data provider build failed!"
    exit 1
fi

# 4. API 패키지 빌드
echo "Building API package..."
npm run build:api
if [ $? -ne 0 ]; then
    echo "❌ API package build failed!"
    exit 1
fi

# 5. 클라이언트 패키지 빌드
echo "Building client package..."
npm run build:client-package
if [ $? -ne 0 ]; then
    echo "❌ Client package build failed!"
    exit 1
fi

# 6. 최종 프론트엔드 빌드
echo "Building frontend..."
npm run frontend
if [ $? -ne 0 ]; then
    echo "❌ Frontend build failed!"
    exit 1
fi

echo "✅ All builds completed successfully!"
```

### 3단계: 검증

```bash
#!/bin/bash
# verify-build.sh

echo "🔍 Verifying build results..."

# 패키지 존재 확인
PACKAGES=(
    "packages/data-schemas/dist"
    "packages/data-provider/dist"  
    "packages/api/dist"
    "packages/client/dist"
    "client/dist"
)

for package in "${PACKAGES[@]}"; do
    if [ -d "$package" ]; then
        echo "✅ $package exists"
    else
        echo "❌ $package missing"
        exit 1
    fi
done

# TypeScript 타입 체크
echo "Checking TypeScript types..."
cd client && npm run typecheck
if [ $? -ne 0 ]; then
    echo "❌ TypeScript check failed!"
    exit 1
fi

echo "✅ Build verification completed!"
```

## 🐛 자주 발생하는 특정 에러들

### `ENOENT` 에러

```bash
Error: ENOENT: no such file or directory, open 'packages/data-provider/dist/index.js'
```

**해결:**
```bash
# data-provider가 빌드되지 않았음
cd packages/data-provider
npm run build
```

### `Cannot find module` 에러

```bash
Error: Cannot find module '@librechat/data-schemas/types'
```

**해결:**
```bash
# 해당 패키지 재빌드
cd packages/data-schemas
npm run build

# 타입 정의 확인
ls -la dist/
```

### `Peer dependency` 경고

```bash
npm WARN peer dep missing: react@^18.0.0, required by some-package@1.0.0
```

**해결:**
```bash
# 정확한 React 버전 설치
npm install react@^19.0.0 react-dom@^19.0.0

# 또는 package.json에 overrides 설정
```

### 메모리 부족 에러

```bash
FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory
```

**해결:**
```bash
# Node.js 메모리 한도 증가
export NODE_OPTIONS="--max-old-space-size=4096"

# 또는 빌드 스크립트에서
NODE_OPTIONS="--max-old-space-size=4096" npm run build
```

## 📋 빌드 문제 예방 체크리스트

### 개발 환경 설정
- [ ] Node.js 18.x LTS 사용
- [ ] 하나의 패키지 매니저만 사용 (npm 또는 yarn)
- [ ] .env 파일 올바르게 설정
- [ ] 적절한 메모리 할당

### 빌드 프로세스
- [ ] 패키지 빌드를 프론트엔드보다 먼저 실행
- [ ] 의존성 순서 준수 (schemas → provider → api → client)
- [ ] 각 단계별 성공 확인
- [ ] 타입 체크 통과

### 문제 발생시
- [ ] 에러 메시지 전체 확인
- [ ] 관련 패키지부터 재빌드
- [ ] 캐시 삭제 후 재시도
- [ ] 로그 파일 확인

이 가이드를 따라하면 대부분의 빌드 문제를 해결할 수 있습니다. 문제가 지속되면 특정 에러 메시지와 함께 이슈를 제기해주세요.