# Package.json 스크립트 가이드 (Yarn 워크스페이스 버전)

LibreChat은 **Yarn 워크스페이스**를 사용하는 모노레포입니다. (`"packageManager": "yarn@4.9.4"`)

## 🧶 Yarn 워크스페이스 기본 구조

```json
{
  "workspaces": [
    "api",
    "client", 
    "packages/*"
  ],
  "packageManager": "yarn@4.9.4"
}
```

## 📦 기본 설치 및 의존성 관리

### **🏁 처음 시작할 때**
```bash
# Yarn 설치 (필요한 경우)
npm install -g yarn

# 모든 워크스페이스 의존성 설치
yarn install

# 또는
yarn
```

### **의존성 관리**
```bash
# 루트에서 모든 워크스페이스 의존성 설치
yarn install

# 특정 워크스페이스에 패키지 추가
yarn workspace client add react-router-dom
yarn workspace api add express

# 루트 레벨에 devDependencies 추가  
yarn add -D eslint prettier

# 모든 워크스페이스 클린 후 재설치
yarn clean   # (있는 경우)
rm -rf node_modules */node_modules packages/*/node_modules
yarn install
```

## 🚀 스크립트 명령어 사용법 (Yarn 기반)

### **🔧 개발 환경 설정**

#### **처음 프로젝트 시작**
```bash
# 1. Yarn으로 모든 의존성 설치
yarn install

# 2. 패키지 빌드 (순서 중요!)
yarn build:data-schemas     # 1순위: 스키마 빌드
yarn build:data-provider    # 2순위: API 라이브러리  
yarn build:api              # 3순위: 백엔드 공통 로직
yarn build:client-package   # 4순위: UI 컴포넌트

# 3. 개발 서버 시작
yarn backend:dev            # 터미널 1 (백엔드)
yarn frontend:dev           # 터미널 2 (프론트엔드)
```

### **📦 빌드 관련 명령어**

#### **개별 패키지 빌드** (Yarn 워크스페이스 활용)
```bash
# 스크립트로 실행 (package.json의 스크립트 사용)
yarn build:data-schemas     # packages/data-schemas 빌드
yarn build:data-provider    # packages/data-provider 빌드  
yarn build:api              # packages/api 빌드
yarn build:client-package   # packages/client 빌드

# 또는 워크스페이스 직접 실행
yarn workspace @librechat/data-schemas build
yarn workspace librechat-data-provider build
yarn workspace @librechat/api build
yarn workspace @librechat/client build
```

#### **전체 프론트엔드 빌드**
```bash
yarn frontend               # 모든 패키지 + 클라이언트 빌드
yarn frontend:ci            # CI 환경용 빌드
```

### **🖥️ 서버 실행**

#### **백엔드 서버**
```bash
yarn backend                # 프로덕션 모드
yarn backend:dev            # 개발 모드 (nodemon)
yarn backend:stop           # 서버 중지
```

#### **프론트엔드 개발 서버**
```bash
yarn frontend:dev           # Vite 개발 서버 시작
# 내부적으로: cd client && yarn dev
```

### **👥 사용자 관리**

```bash
# 사용자 계정 관리
yarn create-user            # 새 사용자 생성
yarn list-users             # 사용자 목록
yarn delete-user            # 사용자 삭제
yarn ban-user               # 사용자 차단
yarn reset-password         # 패스워드 재설정
yarn invite-user            # 사용자 초대

# 잔액 관리
yarn add-balance            # 토큰 잔액 추가
yarn set-balance            # 잔액 설정
yarn list-balances          # 잔액 목록
yarn user-stats             # 사용자 통계
```

### **🧪 테스트**

```bash
# 유닛 테스트
yarn test:client            # 프론트엔드 테스트
yarn test:api               # 백엔드 테스트

# 또는 워크스페이스 직접 실행
yarn workspace client test:ci
yarn workspace api test:ci

# E2E 테스트
yarn e2e                    # Playwright 로컬 테스트
yarn e2e:headed             # 브라우저 보며 테스트
yarn e2e:a11y               # 접근성 테스트
yarn e2e:debug              # 디버그 모드
yarn e2e:codegen            # 테스트 코드 생성
```

### **🔍 코드 품질**

```bash
# 린트 및 포맷팅
yarn lint                   # ESLint 검사 
yarn lint:fix               # 자동 수정
yarn format                 # Prettier 포맷팅

# TypeScript 타입 체크
yarn workspace client typecheck
```

### **🐳 배포**

```bash
# Docker 배포
yarn start:deployed         # 프로덕션 Docker 시작
yarn stop:deployed          # Docker 컨테이너 중지
yarn update:deployed        # 배포 업데이트
yarn rebase:deployed        # Rebase 포함 업데이트
```

### **🛠️ 시스템 관리**

```bash
# 의존성 업데이트 및 재설치
yarn update                 # 패키지 업데이트
yarn reinstall              # 전체 재설치
yarn update:local           # 로컬만 업데이트
yarn update:docker          # Docker 환경 업데이트

# 시스템 유지보수
yarn flush-cache            # Redis 캐시 삭제
yarn reset-meili-sync       # MeiliSearch 재설정
yarn reset-terms            # 이용약관 리셋

# 배너 관리  
yarn update-banner          # 공지 배너 업데이트
yarn delete-banner          # 배너 삭제
```

### **🔄 데이터 마이그레이션**

```bash
# 권한 마이그레이션
yarn migrate:agent-permissions:dry-run      # 에이전트 권한 미리보기
yarn migrate:agent-permissions             # 실행
yarn migrate:prompt-permissions:dry-run    # 프롬프트 권한 미리보기
yarn migrate:prompt-permissions           # 실행
```

## 🧶 Yarn 워크스페이스 특화 명령어

### **워크스페이스별 직접 명령 실행**
```bash
# 특정 워크스페이스에서 스크립트 실행
yarn workspace client dev                  # 클라이언트 개발 서버
yarn workspace api test                   # API 테스트
yarn workspace @librechat/data-schemas build

# 모든 워크스페이스에서 동일한 명령 실행
yarn workspaces foreach run build         # 모든 워크스페이스 빌드
yarn workspaces foreach run test          # 모든 워크스페이스 테스트
yarn workspaces foreach --parallel run build  # 병렬 실행
```

### **의존성 분석**
```bash
# 워크스페이스 구조 확인
yarn workspaces list

# 의존성 트리 확인
yarn why package-name

# 중복 패키지 확인
yarn dedupe
```

## 🎯 Yarn 기반 개발 워크플로우

### **🏁 신규 개발자 온보딩**
```bash
# 1. 프로젝트 클론
git clone https://github.com/danny-avila/LibreChat.git
cd LibreChat

# 2. Yarn 설치 및 의존성 설치
yarn install

# 3. 환경변수 설정
cp .env.example .env
# .env 파일 편집

# 4. 패키지 빌드 (순서대로!)
yarn build:data-schemas
yarn build:data-provider
yarn build:api
yarn build:client-package

# 5. 개발 서버 시작
yarn backend:dev            # 터미널 1
yarn frontend:dev           # 터미널 2
```

### **🔄 일반적인 개발 사이클**
```bash
# 1. 최신 코드 동기화
git pull origin main
yarn install                # 새로운 의존성이 있을 수 있음

# 2. 패키지 재빌드 (필요시)
yarn build:data-schemas     # 스키마 변경시
yarn build:data-provider    # API 인터페이스 변경시

# 3. 개발 및 테스트
yarn backend:dev            # 백엔드 개발
yarn frontend:dev           # 프론트엔드 개발
yarn test:client            # 테스트 실행

# 4. 코드 품질 검사
yarn lint:fix
yarn format

# 5. 빌드 확인
yarn frontend               # 프로덕션 빌드 테스트
```

### **🐛 문제 해결 프로세스**
```bash
# 1. 의존성 문제 해결
rm -rf node_modules */node_modules packages/*/node_modules yarn.lock
yarn install

# 2. 패키지 빌드 문제
yarn build:data-schemas
yarn build:data-provider
yarn build:api
yarn build:client-package

# 3. 캐시 문제
yarn flush-cache
yarn workspace client run dev --force

# 4. TypeScript 문제
yarn workspace client typecheck
yarn workspace api typecheck
```

## ⚠️ Yarn 사용시 주의사항

### **🚫 하지 말아야 할 것들**
```bash
# ❌ npm과 yarn 혼용 금지
npm install                 # yarn.lock이 있는데 package-lock.json 생성
npm run build              # package.json에 npm 명령어가 있어도 yarn 사용 권장

# ❌ 워크스페이스 루트에서 개별 패키지 설치
npm install react          # yarn workspace client add react 사용
```

### **✅ 올바른 사용법**
```bash
# ✅ Yarn 명령어로 통일
yarn install
yarn build:data-schemas
yarn workspace client add react
yarn workspaces foreach run build
```

### **패키지 매니저 확인**
```bash
# 현재 설정된 패키지 매니저 확인
cat package.json | grep packageManager
# "packageManager": "yarn@4.9.4"

# Yarn 버전 확인
yarn --version
```

## 🔧 Yarn 워크스페이스의 장점

1. **의존성 호이스팅**: 공통 의존성을 루트에서 관리
2. **빠른 설치**: 중복 패키지 제거로 설치 속도 향상  
3. **버전 일관성**: 워크스페이스 간 패키지 버전 통일
4. **개발 효율성**: 로컬 패키지 간 심볼릭 링크 자동 생성
5. **스크립트 관리**: 루트에서 모든 워크스페이스 스크립트 실행 가능

이제 LibreChat을 Yarn 워크스페이스 기반으로 올바르게 사용할 수 있습니다!